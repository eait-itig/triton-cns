# EAIT-CNS

This repository contains EAIT specific changes to Joyent's Triton CNS. These
changes are to provide backwards compatibility with zone-dns features. This
document outlines the difference between CNS an EAIT-CNS. For CNS features, see
the operator guide.

## Changes

### Generate Records
EAIT-CNS generates records in the format:
`alias.<zonename>` and `login-alias.<zonename>`.

For the `alias.<zonename>` records, we use a first come first served basis,
where if the alias/shortname is already owned by an existing user, only the
single `login-alias.<zonename>` record is generated. Shortnames and their
ownerships are recorded in redis under the key `shortname:<shortname>`.

TXT records have been modified to have the form `<vm.uuid>@<server.uuid>`
for use with `sdc-zlogin`.

#### Manually changing short-name ownership
To manually change who owns a shortname (if one is already taken), you can
manually modify the `shortname:<zonename>` record in redis and update
the owner and vms field with the new owner/vm:

```
redis 127.0.0.1:6379> GET shortname:test
"{\"type\":\"shortname\",\"owner\":\"47a62fd0-861f-448b-9848-a34c5277d938\",\"vms\":[\"92cff890-7fe0-ef77-f595-bd7085bb6a03\"]}"
redis 127.0.0.1:6379> SET shortname:test "{\"type\":\"shortname\",\"owner\":\"ba6814e3-1b4a-48ba-a665-2f3bdc71e86d\",\"vms\":[\"050ff9f9-e619-4eda-8f4a-af59ecee0d6d\"]}"
```

### Reverse Proxy
EAIT-CNS adds the ability to specify a reverse proxy for a zone.

Instead of generating a record that points directly at the zone's IP address,
we can specify a proxy address that all records generate to. This can be
configured on a per-network basis:

```
# cnsadm zones uqcloud.net
zone:            uqcloud.net
networks:        *
peers:           ns.domain.com
hidden_primary:  true
proxy_addr:      192.168.0.10
proxy_networks:  0123-4567-8901-2345-678901
```

In this example, the zone `uqcloud.net` will generate records for all
networks, but for any zone that uses the network
`0123-4567-8901-2345-678901`, it will generate an A record that points to
the `proxy_addr` of 192.168.0.10.

### Load Balancing Records
In order to provide autogenerated load balancing features, the
`triton.cns.services` tag now generates both the `.svc.` records as the
original CNS does, but will generate a `<servicename>.<zonename>` record if
the zone is on a defined poxy network. This record contains a TXT record that
has the related `.svc.` record. Look at the `zone-lb-gen-new` script on
the clouds to see how these records are used to generate load balancing on the
proxies.

### Custom Records
Custom records can be generated using the `eait_load` script:

```
Usage:
 ./eait_load.sh [ custom | servers ]
```

There are two modes, custom and servers.

#### custom
If custom is specified, EAIT-CNS will add custom records as defined in
`etc/eait_zones.json` and are in the format:

```
{
   "uqcloud.net": [
     {
       "name": "",
       "records": [
         { "A": [ 192.168.0.1 ] }
       ]
     },
     {
       "name": "foo",
       "records": [
          { "CNAME": [ "uqcloud.net" ] },
          { "TXT": [ "bar" ] }
        ]
     }
   ]
}
```

This allows EAIT CNS to add records to zones that don't neccessarily match to a
specific VM.

#### servers
The `servers` sub-command will generate new records for
`zones.eait.uq.edu.au` (currently hard coded) for each physical machine. It
adds both a `<hostname>.zones.eait.uq.edu.au` and a
`<server.uuid>.zones.eait.uq.edu.au` record for each server.

### IXFR
EAIT-CNS doesn't currently support IXFR due to the added complexity of patching
CNS to support adding custom records. This might be implemented in the future.

## TODO
* Run this as separate project from CNS using the MG build system rather than a
set of patches on top of CNS
* IXFR
